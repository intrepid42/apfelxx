\documentclass[10pt,a4paper]{article}
\usepackage{amsmath,amssymb,bm,makeidx,subfigure}
\usepackage[italian,english]{babel}
\usepackage[center,small]{caption}[2007/01/07]
\usepackage{fancyhdr}
\usepackage{color}

\definecolor{blu}{rgb}{0,0,1}
\definecolor{verde}{rgb}{0,1,0}
\definecolor{rosso}{rgb}{1,0,0}
\definecolor{viola}{rgb}{1,0,1}
\definecolor{arancio}{rgb}{1,0.5,0}
\definecolor{celeste}{rgb}{0,1,1}
\definecolor{rosa}{rgb}{1,0.3,0.5}

\oddsidemargin = 12pt
\topmargin = 0pt
\textwidth = 440pt
\textheight = 650pt

\makeindex

\begin{document}

\section{Structure of the observables}

Let us start from Eq.~(2.6) of Ref.~\cite{Scimemi:2017etj}, that is
the fully differential cross section for lepton-pair production in the
region in which the TMD factorisation applies, $i.e.$ $q_T \ll
Q$. After some minor manipulations, it reads:
\begin{equation}\label{eq:crosssection}
  \frac{d\sigma}{dQ dy dq_T} =
  \frac{16\pi\alpha^2q_T}{9 Q^3} H(Q,\mu) \sum_q C_q(Q)
  \int\frac{d^2\mathbf{b}}{4\pi} e^{i \mathbf{b}\cdot \mathbf{q}_T} \overline{F}_q(x_1,\mathbf{b};\mu,\zeta) \overline{F}_{\bar{q}}(x_2,\mathbf{b};\mu,\zeta)\,,
\end{equation}
where $Q$, $y$, and $q_T$ are the invariant mass, the rapidity, and
the transverse momentum of the lepton pair, respectively, while
$\alpha$ is the electromagnetic coupling, $H$ is the appropriate QCD
hard factor that can be perturbatively computed, and $C_q$ are the
effective electroweak charges. In addition, the variables $x_1$ and
$x_2$ are functions of $Q$ and $y$ and are given by:
\begin{equation}\label{eq:Bjorkenx12}
  x_{1,2} = \frac{Q}{\sqrt{s}}e^{\pm y}\,,
\end{equation}
being $\sqrt{s}$ the centre-of-mass energy of the collision. In
Eq.~(\ref{eq:crosssection}) we are using the short-hand notation:
\begin{equation}
\overline{F}_q(x,\mathbf{b};\mu,\zeta) \equiv xF_q(x,\mathbf{b};\mu,\zeta)\,,
\end{equation}
that is convenient for the implementation. The scales $\mu$ and
$\zeta$ are introduced as a consequence of the removal of UV and
rapidity divergences in the definition of the TMDs. Despite these
scales are arbitrary scales, they are typically chosen
$\mu=\sqrt{\zeta}=Q$. Therefore, for all practical purposes their
presence is fictitious.

The computation-intensive part of Eq.(\ref{eq:crosssection}) has the
form of the integral:
\begin{equation}\label{eq:integral}
I_{ij}(x_1,x_2,q_T;\mu,\zeta)=\int\frac{d^2\mathbf{b}}{4\pi} e^{i \mathbf{b}\cdot \mathbf{q}_T} \overline{F}_i(x_1,\mathbf{b};\mu,\zeta) \overline{F}_{j}(x_2,\mathbf{b};\mu,\zeta)\,.
\end{equation}
where $\overline{F}_{i(j)}$ are combinations of evolved TMD PDFs. At
this stage, for convenience, $i$ and $j$ do not coincide with $q$ and
$\bar{q}$ but they are linked through a simple linear
transformation. The integral over the bidimensional impact parameter
\textbf{b} has to be taken. However, $\overline{F}_{i(j)}$ only depend
on the absolute value of \textbf{b}, therefore Eq.~(\ref{eq:integral})
can be written as:
\begin{equation}\label{eq:integral2}
I_{ij}(x_1,x_2,q_T;\mu,\zeta)=\frac12\int_0^\infty db\,b J_0(bq_T)  \overline{F}_i(x_1,b;\mu,\zeta) \overline{F}_{j}(x_2,b;\mu,\zeta)\,.
\end{equation}
where $J_0$ is the zero-th order Bessel function of the first kind
whose integral representation is:
\begin{equation}
J_0(x) = \frac1{2\pi}\int_0^{2\pi} d\theta e^{ix\cos(\theta)}\,.
\end{equation}
The evolved quark TMD PDF $\overline{F}_i$ at the final scales $\mu$
and $\zeta$ is obtained by multiplying the same distribution at the
initial scales $\mu_0$ and $\zeta_0$ by a single evolution factor
$R_q$(\footnote{Note that in Eq.~(\ref{eq:crosssection}) the gluon TMD
  PDF $\overline{F}_g$ is not involved. If also the gluon TMD PDF was
  involved, it would evolve by means of a different evolution factor
  $R_g$.}).  that is:
\begin{equation}\label{eq:evolution}
  \overline{F}_i(x,b;\mu,\zeta) = R_q(\mu_0,\zeta_0\rightarrow \mu,\zeta;b)
  \overline{F}_i(x,b;\mu_0,\zeta_0)\,.
\end{equation}

The initial scale TMD PDFs at small values $b$ can be written as:
\begin{equation}\label{eq:LOconv}
\overline{F}_i(x,b;\mu_0,\zeta_0) = \sum_{j=g,q(\bar{q})}x\int_x^1\frac{dy}{y}C_{ij}(y;\mu_0,\zeta_0)f_j\left(\frac{x}{y},\mu_0\right)\,,
\end{equation}
where $f_j$ are the collinear PDFs (including the gluon) and $C_{ij}$
are the so-called matching functions that are perturbatively
computable and are currently known to NNLO, $i.e.$
$\mathcal{O}(\alpha_s^2)$. If we define:
\begin{equation}
\overline{f}_i\left(x,\mu_0\right) = xf_i\left(x,\mu_0\right)\,,
\end{equation}
Eq.~(\ref{eq:LOconv}) can be written as:
\begin{equation}\label{eq:LOconvMod}
\overline{F}_i(x,b;\mu_0,\zeta_0) =
\sum_{j=g,q(\bar{q})}\int_x^1dy\,C_{ij}(y;\mu_0,\zeta_0)  \overline{f}_i\left(\frac{x}{y},\mu_0\right)\,.
\end{equation}
Putting Eqs.~(\ref{eq:evolution}) and~(\ref{eq:LOconvMod}), one finds:
\begin{equation}\label{eq:pertTMD}
  \overline{F}_i(x,b;\mu,\zeta) = R_q(\mu_0,\zeta_0\rightarrow \mu,\zeta;b)
  \sum_{j=g,q(\bar{q})}\int_x^1dy\,C_{ij}(y;\mu_0,\zeta_0)  \overline{f}_i\left(\frac{x}{y},\mu_0\right)\,.
\end{equation}

Matching and evolution are affected by non-perturbative effects that
become relevant at large $b$. In order to account for such effects,
one usually introduces a phenomenological function $f_{\rm NP}$. In
the traditional approach (CSS~\cite{Collins:2011zzd}), the $b$-space
TMDs get a multiplicative correction that does not depend on the
flavour. In addition, the perturbative content of the TMDs is smoothly
damped away at large $b$ by introducing the so-called
$b_*$-prescription:
\begin{equation}\label{eq:LOconvNP1}
  \overline{F}_i(x,b;\mu,\zeta) \rightarrow \overline{F}_i(x,b_*(b);\mu,\zeta) f_{\rm NP}(x,b,\zeta)\,,
\end{equation}
where $b_*\equiv b_*(b)$ is a monotonic function of the impact
parameter $b$ such that:
\begin{equation}
  \lim_{b\rightarrow 0}
  b_*(b) = b_{\rm min}\quad\mbox{and}\quad\lim_{b\rightarrow \infty}
  b_*(b) = b_{\rm max}\,,
\end{equation}
being $b_{\rm min}$ and $b_{\rm max}$ constant values both in the
perturbative region. Including the non-perturbative function,
Eq.~(\ref{eq:integral2}) becomes:
\begin{equation}\label{eq:integral3}
\begin{array}{l}
\displaystyle I_{ij}(x_1,x_2,q_T;\mu,\zeta) = \displaystyle \int_0^\infty db\,J_0(bq_T)\left[\frac{b}2 
\overline{F}_i(x_1,b_*(b);\mu,\zeta) \overline{F}_{j}(x_2,b_*(b);\mu,\zeta) f_{\rm NP}(x_1,b,\zeta)
  f_{\rm NP}(x_2,b,\zeta) \right]\\
\\
\displaystyle =\frac{1}{q_T}\int_0^\infty d\bar{b}\,J_0(\bar{b})\left[\frac{\bar{b}}{2q_T} 
\overline{F}_i(x_1,b_*\left(\frac{\bar{b}}{q_T}\right);\mu,\zeta) \overline{F}_{j}(x_2,,b_*\left(\frac{\bar{b}}{q_T}\right);\mu,\zeta) f_{\rm NP}\left(x_1,\frac{\bar{b}}{q_T},\zeta\right)
  f_{\rm NP}\left(x_2,\frac{\bar{b}}{q_T},\zeta\right) \right]
\,.
\end{array}
\end{equation}
Eq.~(\ref{eq:integral3}) is a Hankel tranform and can be efficiently
computed using the so-called Ogata quadrature~\cite{Ogata:quadrature}.
Effectively, the computation of the integral in
Eq.~(\ref{eq:integral}) is achieved through a weighted sum:
\begin{equation}\label{eq:ogataquadrature}
\begin{array}{rcl}
I_{ij}(x_1,x_2,q_T;\mu,\zeta) &\simeq& \displaystyle
                                                     \frac1{q_T}\sum_{n=1}^N
                                                     \frac{w_n^{(0)}z_n^{(0)}}{2q_T} 
\overline{F}_i\left(x_1,b_*\left
                                       (\frac{z_n^{(0)}}{q_T}\right);\mu,\zeta\right) \overline{F}_j\left(x_2,b_*\left (\frac{z_n^{(0)}}{q_T}\right);\mu,\zeta\right)\\
\\
&\times&\displaystyle f_{\rm NP}\left(x_1,\frac{z_n^{(0)}}{q_T},\zeta\right)
  f_{\rm NP}\left(x_2,\frac{z_n^{(0)}}{q_T},\zeta\right)\,,
\end{array}
\end{equation}
where the unscaled coordinates $z_n^{(0)}$ and the weights $w_n^{(0)}$
can be precomputed in terms of the zero's of the Bessel function $J_0$
and one single parameter (see Ref.~\cite{Ogata:quadrature} for more
details, specifically Eqs.~(5.1) and~(5.2) or
Appendix~\ref{app:OgataQuadrature} for the relevant formula to compute
the unscaled coordinates and the weights)\footnote{The superscript 0
  in $z_n^{(0)}$ and $w_n^{(0)}$ indicates that here we are performing
  a Hankel tranform that involves the Bessel function of degree zero
  $J_0$. This is useful in view of the next section in which the
  integration over $q_T$ will give rise to a similar Hankel transform
  with $J_0$ replaced by $J_1$. Also in that case the Ogata quadrature
  algorithm can be applied but coordinates and weights will be
  different.}. Based on the (empirically verified) assumption that the
absolute value of each term in the sum in the r.h.s. of
Eq.~(\ref{eq:ogataquadrature}) is smaller than that of the preceding
one, the truncation number $N$ is chosen dynamically in such a way
that the $(N+1)$-th term is smaller in absolute value than a
user-defined cutoff relatively to the sum of the preceding $N$ terms.

Eq.~(\ref{eq:ogataquadrature}) factors out the non-perturbative part
of the calculation represented by $f_{\rm NP}$ from the perturbative
content. This is done on purpose to devise a method in which the
perturbative content is precomputed and numerically convoluted with
the non-perturbative functions \textit{a posteriori}. This is
convenient in view of a fit of the function $f_{\rm NP}$.

As customary in QCD, the most convenient basis for the matching in
Eq.~(\ref{eq:LOconv}) is the so-called ``evolution'' basis
(\textit{i.e.} $\Sigma$, $V$, $T_3$, $V_3$, etc.). In fact, in this
basis the operator matrix $C_{ij}$ is almost diagonal with the only
exception of crossing terms that couple the gluon and the singlet
$\Sigma$ distributions. As a consequence, this is the most convenient
basis for the computation of $I_{ij}$. On the other hand, TMDs in
Eq.~(\ref{eq:crosssection}) appear in the so-called ``physical'' basis
(\textit{i.e.} $d$, $\bar{d}$, $u$, $\bar{u}$, etc.). Therefore, we
need to rotate $F_{i(j)}$ from the evolution basis, over which the
indices $i$ and $j$ run, to the physical basis. This is done by means
of an appropriate constant matrix $T$, so that:
\begin{equation}\label{eq:lumiInterRot}
\overline{F}_{q}(x_1,b;\mu,\zeta)= \sum_{i}T_{qi}F_{i}(x_1,b;\mu,\zeta)\,,
\end{equation}
and similarly for $\overline{F}_{\bar{q}}$. Putting all pieces
together, one can conveniently write the cross section in
Eq.~(\ref{eq:crosssection}) as:
\begin{equation}\label{eq:fastdiffxsec}
  \frac{d\sigma}{dQ dy dq_T} \simeq\sum_{n=1}^N w_n^{(0)} \frac{z_n^{(0)}}{q_T}S\left(x_1,x_2,\frac{z_n^{(0)}}{q_T};\mu,\zeta\right) f_{\rm NP}\left(x_1,\frac{z_n^{(0)}}{q_T},\zeta\right) f_{\rm NP}\left(x_2,\frac{z_n^{(0)}}{q_T},\zeta\right)\,,
\end{equation}
with:
\begin{equation}\label{eq:pertfact}
S(x_1,x_2,b;\mu,\zeta) =\frac{8\pi\alpha^2}{9 Q^3}
    H(Q,\mu) \sum_q C_q(Q) \left[
\overline{F}_q\left(x_1,b_*(b);\mu,\zeta \right)\right] \left[
\overline{F}_{\bar{q}}\left(x_2,b_*(b);\mu,\zeta \right)\right]\,.
\end{equation}
Eq.~(\ref{eq:fastdiffxsec}) allows one to precompute the weights $S$
in such a way that the differential cross section in
Eq.~(\ref{eq:crosssection}) can be computed as a simple weighted sum
of the non-perturbative contribution. A misleading aspect of
Eq.~(\ref{eq:pertfact}) is the fact that $S$ has five arguments. In
actual facts, $S$ only depends on three independent variables. The
reason is that $\mu$ and $\zeta$ are usually taken to be proportional
to $Q$ by a constant factor. In addition $x_1$ and $x_2$ depend on $Q$
and $y$ through Eq.~(\ref{eq:Bjorkenx12}). Therefore, the full
dependence on the kinematics of the final state of
Eq.~(\ref{eq:crosssection}) can be specified by $Q$, $y$ and $q_T$.

\section{Integrating over the final-state kinematic variables}

Despite Eq.~(\ref{eq:fastdiffxsec}) provides a powerful tool for a
fast computation of cross sections, it is often not sufficient to
allow for a direct comparison to experimental data. The reason is that
experimental measurements of differential distributions are usually
delivered as integrated over finite regions of the final-state
kinematic phase space. In other words, experiments measure quantities
like:
\begin{equation}\label{eq:Intcrosssection}
\widetilde{\sigma}=\int_{Q_{\rm min}}^{Q_{\rm max}}dQ \int_{y_{\rm min}}^{y_{\rm max}}dy \int_{q_{T,\rm min}}^{q_{T,\rm max}}dq_T\left[\frac{d\sigma}{dQ dy dq_T} \right]\,.
\end{equation}
As a consequence, in order to guarantee performance, we need to
include the integrations above in the precomputed factors. 

\subsection{Integrating over $q_T$}

The integration over bins in $q_T$ can be carried out analytically
exploiting the following property of Bessel's function:
\begin{equation}
\frac{d}{dx}\left[x^mJ_m(x)\right]=x^mJ_{m-1}(x)\,,
\end{equation}
that leads to:
\begin{equation}\label{eq:besselproperty}
\int dx\,x J_0(x) = xJ_1(x)\quad\Rightarrow\quad \int_{x_1}^{x_2}
dx\,x J_0(x) = x_2J_1(x_2) - x_1J_1(x_1)\,.
\end{equation}
To see it, we observe that the differential cross section in
Eq.~(\ref{eq:crosssection}) has the following structure:
\begin{equation}
  \frac{d\sigma}{dQ dy dq_T} \propto \int_0^\infty db\, q_T  J_0(bq_T)\dots
\end{equation}
where the ellipses indicate terms that do not depend on
$q_T$. Therefore, using Eq.~(\ref{eq:besselproperty}) we find:
\begin{equation}
\begin{array}{l}
\displaystyle \int_{q_{T,\rm min}}^{q_{T,\rm
  max}}dq_T\left[\frac{d\sigma}{dQ dy dq_T} \right] \propto \int_0^\infty db\,
  \int_{q_{T,\rm min}}^{q_{T,\rm
  max}} dq_T\,   q_T J_0(bq_T)\dots= \\
\\
\displaystyle \int_0^\infty \frac{db}{b^2}\,
  \int_{bq_{T,\rm min}}^{bq_{T,\rm
  max}} dx\,   x J_0(x)\dots=\int_0^\infty \frac{db}{b}\left[q_{T,\rm
  max}J_1(bq_{T,\rm max}) - q_{T,\rm
  min}J_1(bq_{T,\rm min})\right]\dots\,.
\end{array}
\end{equation}
Therefore, defining:
\begin{equation}
K(q_T) \equiv \int dq_T\left[\frac{d\sigma}{dQ dy dq_T} \right]
\end{equation}
as the indefinite integral over $q_T$ of the cross section in
Eq.~(\ref{eq:crosssection}), we have that:
\begin{equation}\label{eq:primitive}
\int_{q_{T,\rm min}}^{q_{T,\rm
  max}}dq_T\left[\frac{d\sigma}{dQ dy dq_T} \right] = K(Q,y,q_{T,\rm max})
- K(Q,y,q_{T,\rm min})\,,
\end{equation}
with:
\begin{equation}\label{eq:Kexplicit}
\begin{array}{l}
 \displaystyle K(Q,y,q_T) =
  \frac{8\pi\alpha^2q_T}{9 Q^3} H(Q,\mu) \\
\\
\displaystyle \times
  \int_0^\infty db\, J_1(bq_T) \sum_q C_q(Q)\overline{F}_q(x_1,b;\mu,\zeta) \overline{F}_{\bar{q}}(x_2,b;\mu,\zeta) f_{\rm NP}(x_1,b,\zeta)
  f_{\rm NP}(x_2,b,\zeta)\,,
\end{array}
\end{equation}
that can be computed using the Ogata quadrature as:
\begin{equation}
  K(Q,y,q_T) \simeq \sum_{n=1}^N w_n^{(1)} S\left(x_1,x_2,\frac{z_n^{(1)}}{q_T};\mu,\zeta\right) f_{\rm NP}\left(x_1,\frac{z_n^{(1)}}{q_T},\zeta\right) f_{\rm NP}\left(x_2,\frac{z_n^{(1)}}{q_T},\zeta\right)\,,
\end{equation}
with $S$ defined in Eq.~(\ref{eq:pertfact}). The unscaled coordinates
$z_n^{(1)}$ and the weights $w_n^{(1)}$ can again be precomputed and
stored in terms of the zero's of the Bessel function
$J_1$. Eq.~(\ref{eq:primitive}) reduces the integration in $q_T$ to a
calculation completely analogous to the unintegrated cross
section. This is particularly convenient because it avoids the
computation a numerical integration.

\subsubsection{Kinematic cuts}\label{sec:kincuts}

In the presence of kinematic cuts, such as those on the final-state
leptons in Drell-Yan, the analytic integration over $q_T$ discussed
above cannot be performed. The reason is that the implementation of
these cuts effectively introduces a $q_T$-dependent function
$\mathcal{P}$(\footnote{In fact, $\mathcal{P}$ also depends on the
  invariant mass $Q$ and the rapidity $y$ of the lepton pair that also
  need to be integrated over.}) in the integral:
\begin{equation}
  \frac{d\sigma}{dQ dy dq_T} \propto \int_0^\infty db\, q_T  J_0(bq_T)\mathcal{P}(q_T)\dots\,,
\end{equation}
that prevents the direct use of Eq.~(\ref{eq:besselproperty}).
% However, integrating by parts, we can write(\footnote{Notice that the
%   lower bound of the integral in the r.h.s., that is 0 here, is
%   actually arbitrary because the final result does not depend on
%   it.}):
% \begin{equation}
%   \int_{q_{T,\rm min}}^{q_{T,\rm
%       max}} dq_T\, q_T J_0(bq_T) \mathcal{P}(q_T)= \frac{1}{b}\left[q_T J_1(bq_T) \mathcal{P}(q_T)- \int_{0}^{q_{T}} d\bar{q}_T\, \bar{q}_T J_1(b\bar{q}_T) \mathcal{P}'(\bar{q}_T)\right]\Bigg|_{q_{T,\rm min}}^{q_{T,\rm
%       max}}\,.
% \end{equation}
% Now, if we assume that $\mathcal{P}$ is a slowly-varying function of
% $q_T$ (\textit{i.e.} $\mathcal{P}'$ is small), we could, in first
% approximation, neglect the second term in the r.h.s. of the equation
% above. Unfortunately, despite $\mathcal{P}$ is an actual
% slowly-varying function of $q_T$, the contribution of the integral in
% the r.h.s. is still large, particularly at large $q_T$. This is mostly
% due to the fact that the integral over $b$ of $J_1(bq_T)$,
% particularly for large values of $q_T$, is numerically large.
Since $\mathcal{P}$ is a slowly-varying function of $q_T$ over the
typical bin size, we can approximate the integral over the bins in
$q_T$ as:
\begin{equation}\label{eq:intbyparts}
\begin{array}{rcl}
\displaystyle  \int_{q_{T,\rm min}}^{q_{T,\rm
      max}} dq_T\, q_T J_0(bq_T) \mathcal{P}(q_T)&\simeq&\displaystyle
  \mathcal{P}\left(\frac{q_{T,\rm max}+q_{T,\rm min}}2\right)\int_{q_{T,\rm min}}^{q_{T,\rm
      max}} dq_T\, q_T J_0(bq_T) \\
\\
&=& \displaystyle\mathcal{P}\left(\frac{q_{T,\rm max}+q_{T,\rm
    min}}2\right) \frac{1}{b}\left[q_{T,\rm max} J_1(bq_{T,\rm max}) - q_{T,\rm min} J_1(bq_{T,\rm min}) \right]\,.
\end{array}
\end{equation}
Unfortunately, this structure is inconvenient because it mixes
different bin bounds and prevents a recursive computation.
However, we can try to go further and, assuming that the bin width is
small enough, we can expand $\mathcal{P}$ is the following ways:
\begin{equation}
\begin{array}{l}
\displaystyle\mathcal{P}\left(\frac{q_{T,\rm max}+q_{T,\rm
    min}}2\right)= \mathcal{P}\left(q_{T,\rm min}+\Delta q_T\right) =
  \mathcal{P}\left(q_{T,\rm min}\right) + \mathcal{P}'\left(q_{T,\rm
  min}\right)\Delta q_T +\mathcal{O}\left(\Delta q_T^2\right)\,,\\
\\
\displaystyle\mathcal{P}\left(\frac{q_{T,\rm max}+q_{T,\rm
    min}}2\right)= \mathcal{P}\left(q_{T,\rm max}-\Delta q_T\right) =
  \mathcal{P}\left(q_{T,\rm max}\right) - \mathcal{P}'\left(q_{T,\rm
  max}\right)\Delta q_T +\mathcal{O}\left(\Delta q_T^2\right)\,,
\end{array}
\end{equation}
with:
\begin{equation}\label{eq:halfqTinterval}
\Delta q_T = \frac{q_{T,\rm max}- q_{T,\rm min}}2\,.
\end{equation}
Therefore:
\begin{equation}\label{eq:lastexpP}
\begin{array}{rcl}
  \displaystyle  b\int_{q_{T,\rm min}}^{q_{T,\rm
  max}} dq_T\, q_T J_0(bq_T) \mathcal{P}(q_T)&\simeq&\displaystyle
                                                      q_{T,\rm
                                                      max}
                                                      J_1(bq_{T,\rm
                                                      max})\left[
                                                      \mathcal{P}\left(q_{T,\rm
                                                      max}\right)
                                                      - 
                                                      \mathcal{P}'\left(q_{T,\rm
                                                      max}\right)\Delta
                                                      q_T\right]\\
\\
&-&\displaystyle q_{T,\rm
                                                      min}
                                                      J_1(bq_{T,\rm
                                                      min})\left[
                                                      \mathcal{P}\left(q_{T,\rm
                                                      min}\right)
                                                      +
                                                      \mathcal{P}'\left(q_{T,\rm
                                                      min}\right)\Delta
                                                      q_T\right]\,.
\end{array}
\end{equation}
The advantage of this formula as compared to Eq.~(\ref{eq:intbyparts})
is that each single term depends on one single bin-bound in $q_T$
rather than on a combination of two consecutive bounds. Therefore, in
the presence of kinematic cuts, the actual form of the primitive
function $K$ defined in Eq.~(\ref{eq:primitive}) and given explicitly
in Eq.~(\ref{eq:Kexplicit}) is:
\begin{equation}\label{eq:KexplicitCuts}
\begin{array}{l}
 \displaystyle K(Q,y,q_T) =
  \frac{8\pi\alpha^2q_T}{9 Q^3} H(Q,\mu)
  \left[\mathcal{P}\left(Q,y,q_{T}\right) \pm
  \mathcal{P}'\left(Q,y,q_{T}\right)\Delta q_T\right]\\
\\
\displaystyle \times
  \int_0^\infty db\, J_1(bq_T) \sum_q C_q(Q)\overline{F}_q(x_1,b;\mu,\zeta) \overline{F}_{\bar{q}}(x_2,b;\mu,\zeta) f_{\rm NP}(x_1,b,\zeta)
  f_{\rm NP}(x_2,b,\zeta)\,,
\end{array}
\end{equation}
where I have explicitly reinstated the dependence of the function
$\mathcal{P}$ and its derivative with respect to $q_T$,
$\mathcal{P}'$, on $Q$ and $y$. In the square bracket in
Eq.~(\ref{eq:KexplicitCuts}), the minus sign applies when $q_T$ is the
upper bound of the bin and the plus sign when it is the lower bound
(see Eq.~(\ref{eq:lastexpP})). As discussed below, when integrating
over bins in $Q$ and $y$, one should also integrate the functions
$\mathcal{P}$ and $\mathcal{P}'$. However, we will argue that, in the
interpolation procedure discussed below, these functions can be
extracted from the integrals in $Q$ and $y$ in a proper manner in such
a way to avoid computing the expensive function $\mathcal{P}$ many
times and, moreover, simplify enormously the structure of the
resulting interpolation tables.

\subsection{On the position of the peak of the $q_T$ distribution}

It is interesting at this point to take a short detour to discuss the
position of the peak on the distribution in $q_T$ of the cross section
in Eq.~(\ref{eq:crosssection}). The peak can be located by setting the
derivative in $q_T$ of the cross section equal to zero. To do so, we
use another property of Bessel's functions:
\begin{equation}
\frac{dJ_0(x)}{dx} = -J_1(x)\,.
\end{equation}
Using this relation, it is easy to see that:
\begin{equation}
\begin{array}{l}
\displaystyle 0 = \frac{d}{dq_T}  \left[\frac{d\sigma}{dQ dy dq_T}\right]
  =\\
\\
\displaystyle  \frac{8\pi\alpha^2}{9 Q^3} H(Q,\mu) 
  \int_0^\infty db\,b \left[J_0(bq_T) -bq_TJ_1(bq_T)\right] 
\sum_q C_q(Q)\overline{F}_q(x_1,b_*(b);\mu,\zeta)
  \overline{F}_{\bar{q}}(x_2,b_*(b);\mu,\zeta)\\
\\
\displaystyle \times f_{\rm NP}(x_1,b,\zeta)
  f_{\rm NP}(x_2,b,\zeta)\,,
\end{array}
\end{equation}
that is equivalent to require that:
\begin{equation}
  \int_0^\infty db\,b \left[J_0(bq_T) -bq_TJ_1(bq_T)\right] 
  \sum_q C_q(Q)\overline{F}_q(x_1,b_*(b);\mu,\zeta) \overline{F}_{\bar{q}}(x_2,b_*(b);\mu,\zeta) f_{\rm NP}(x_1,b,\zeta)
  f_{\rm NP}(x_2,b,\zeta) = 0\,.
\end{equation}
The integral above can be solved numerically using the technique
discussed above and the value of $q_T$ that satisfies this equation
represents the position of the peak of the $q_T$ distribution.

\subsection{Integrating over $Q$ and $y$}\label{sec:QyInt}

As a final step, we need to perform the integrals over $Q$ and $y$
defined in Eq.~(\ref{eq:Intcrosssection}). To compute these integrals
we can only rely on numerical methods. Having reduced the integration
in $q_T$ to the difference of the two terms in the r.h.s. of
Eq.~(\ref{eq:primitive})(\footnote{For the moment we ignore the
  complication introduced by the presence of cuts on the final state
  discussed in Sect.~\ref{sec:kincuts}. We will come back on this
  issue at the end of the section.}), we can concentrate on
integrating the function $K$ over $Q$ and $y$ for a fixed value of
$q_T$:
\begin{equation}
\widetilde{K}(q_T)=\int_{Q_{\rm min}}^{Q_{\rm max}}dQ \int_{y_{\rm
    min}}^{y_{\rm max}}dy\,K(Q,y,q_T)\,,
\end{equation}
such that:
\begin{equation}
  \widetilde{\sigma} = \widetilde{K} (q_{T,\rm max})- \widetilde{K} (q_{T,\rm min})\,.
\end{equation}
To this purpose, it is convenient to make explicit the dependence of
$x_1$ and $x_2$ on $Q$ and $y$ using Eq.~(\ref{eq:Bjorkenx12}). In
addition, for the sake of simplicity we will identify the scales $\mu$
and $\sqrt{\zeta}$ with $Q$ (possible scale variations can be easily
reinstated at a later stage) and thus drop one of the arguments from
the TMD distributions $\overline{F}$ and from the hard factor $H$.
This yields:
\begin{equation}\label{eq:finalintegral}
\begin{array}{rcl}
\displaystyle  \widetilde{K}(q_T) &=& \displaystyle \frac{8\pi q_T}{9} \int_0^\infty db\, J_1(bq_T)
  \int_{Q_{\rm min}}^{Q_{\rm max}}
  dQ \int_{e^{y_{\rm
    min}}}^{e^{y_{\rm max}}}\frac{d\xi}{\xi}\\
\\
&\times& \displaystyle 
                         \frac{1}{Q^3} \alpha^2(Q) H(Q)\sum_q C_q(Q)\overline{F}_q\left(\frac{Q}{\sqrt{s}}\xi,b_*(b);Q\right)
                         \overline{F}_{\bar{q}}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b_*(b);Q\right) \\
\\
&\times& \displaystyle f_{\rm NP}\left(\frac{Q}{\sqrt{s}}\xi,b;Q\right)
  f_{\rm NP}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b;Q\right)\,,
\end{array}
\end{equation}
where we have performed the change of variable $e^{y} = \xi$. Now we
define one grid in $\xi$, $\{\xi_\alpha\}$ with
$\alpha=0,\dots,N_\xi$, and one grid in $Q$, $\{Q_\tau\}$ with
$\tau=0,\dots,N_Q$, each of which with a set of interpolating
functions $\mathcal{I}$ associated. In addition, the grids are such
that: $\xi_0 = e^{y_{\rm min}}$ and $\xi_{N_\xi} = e^{y_{\rm max}}$,
and $Q_0 = Q_{\rm min}$ and $Q_{N_Q} = Q_{\rm max}$. More details on
the interpolation procedure are presented in
Appendix~\ref{app:LagrangeInterpolation}. This allows us to interpolate
the pair of functions $f_{\rm NP}$ in Eq.~(\ref{eq:finalintegral}) for
generic values of $\xi$ and $Q$ as:
\begin{equation}\label{eq:interpolation}
f_{\rm NP}\left(\frac{Q}{\sqrt{s}}\xi,b;Q\right) f_{\rm NP}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b;Q\right) \simeq \sum_{\alpha=0}^{N_\xi}\sum_{\tau=0}^{N_Q}\mathcal{I}_\alpha(\xi)\mathcal{I}_\tau(Q) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\xi_\alpha,b;Q_\tau\right) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\frac1{\xi_\alpha},b;Q_\tau\right)\,.
\end{equation}
Plugging the equation above into Eq.~(\ref{eq:finalintegral}) we
obtain:
\begin{equation}
\begin{array}{rcl}
\displaystyle  \widetilde{K}(q_T) &\simeq& \displaystyle \frac{8\pi q_T}{9} \int_0^\infty db\, J_1(bq_T)
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_\xi}\Bigg[\int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\mathcal{I}_\tau(Q)\, 
  \frac{1}{Q^3} \alpha^2(Q) H(Q) 
  \\
\\
&\times& \displaystyle 
                         \int_{e^{y_{\rm
    min}}}^{e^{y_{\rm max}}}d\xi\,\mathcal{I}_\alpha(\xi)\,\frac{1}{\xi} \sum_q C_q(Q)\overline{F}_q\left(\frac{Q}{\sqrt{s}}\xi,b_*(b);Q\right)
                         \overline{F}_{\bar{q}}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b_*(b);Q\right)\Bigg] \\
\\
&\times& \displaystyle f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\xi_\alpha,b;Q_\tau\right) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\frac1{\xi_\alpha},b;Q_\tau\right)\,.
\end{array}
\end{equation}
Finally, the integration over $b$ can be performed using the Ogata
quadrature as discussed above, so that:
\begin{equation}
\begin{array}{rcl}
\displaystyle  \widetilde{K}(q_T) &\simeq& \displaystyle \sum_{n=1}^N
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_\xi}\Bigg[\frac{8\pi}{9} w_n^{(1)}\int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\mathcal{I}_\tau(Q)\, 
  \frac{1}{Q^3} \alpha^2(Q) H(Q) 
\\
\\
&\times& \displaystyle 
                         \int_{e^{y_{\rm
    min}}}^{e^{y_{\rm max}}}d\xi\,\mathcal{I}_\alpha(\xi)\,\frac{1}{\xi} \sum_q C_q(Q)\overline{F}_q\left(\frac{Q}{\sqrt{s}}\xi,b_*\left(\frac{z_n}{q_T}\right);Q\right)
                         \overline{F}_{\bar{q}}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b_*\left(\frac{z_n}{q_T}\right);Q\right)\Bigg] \\
\\
&\times& \displaystyle f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\xi_\alpha,\frac{z_n}{q_T};Q_\tau\right) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\frac1{\xi_\alpha},\frac{z_n}{q_T};Q_\tau\right)\,.
\end{array}
\end{equation}
In conclusion, if we define:
\begin{equation}\label{eq:weights}
\begin{array}{rcl}
  \displaystyle  W_{n\tau\alpha}(q_T) & \equiv & \displaystyle w_n^{(1)}\frac{8\pi}{9} \int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\mathcal{I}_\tau(Q)\, 
                                            \frac{\alpha^2(Q)}{Q^3} H(Q) 
                                            \\
  \\
                                 &\times& \displaystyle 
                                          \int_{e^{y_{\rm
                                          min}}}^{e^{y_{\rm max}}}d\xi\,\mathcal{I}_\alpha(\xi)\,\frac{1}{\xi} \sum_q C_q(Q)\overline{F}_q\left(\frac{Q}{\sqrt{s}}\xi,b_*\left(\frac{z_n}{q_T}\right);Q\right)
                                          \overline{F}_{\bar{q}}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b_*\left(\frac{z_n}{q_T}\right);Q\right)\,,
\end{array}
\end{equation}
the quantity $\widetilde{K}(q_T)$ can be computed as:
\begin{equation}\label{eq:finalinterpolated}
\widetilde{K}(q_T) \simeq \sum_{n=1}^N
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_\xi} W_{n\tau\alpha}(q_T) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\xi_\alpha,\frac{z_n}{q_T};Q_\tau\right) f_{\rm NP}\left(\frac{Q_\tau}{\sqrt{s}}\frac1{\xi_\alpha},\frac{z_n}{q_T};Q_\tau\right)\,.
\end{equation}
The advantage of Eq.~(\ref{eq:finalinterpolated}) is that the weights
$W_{n\alpha\tau}$, that clearly depend on $q_T$ but also on the
intervals $[Q_{\rm min}:Q_{\rm max}]$ and $[y_{\rm min}:y_{\rm max}]$,
can be precomputed once and for all for each of the experimental
points included in a fit and used to determine the function
$f_{\rm NP}$.  This provides a fast tool for the computation of
predictions that makes the extraction of the non-perturbative part of
the TMDs much easier.

It is now time to discuss how the weights defined in
Eq.~(\ref{eq:weights}) are affected by the presence of cuts as
discussed in Sect.~\ref{sec:kincuts}. In principle, the function
between square brackets in Eq.~(\ref{eq:KexplicitCuts}) should be
inside the integrals in Eq.~(\ref{eq:weights}) and integrated over the
variable $Q$ and $\xi=e^y$. However, this turns out to be numerically
problematic because the phase-space-reduction function $\mathcal{P}$
is expensive to compute. On top of this, the fact that the factor
between square brackets in Eq.~(\ref{eq:KexplicitCuts}) depends on
whether $q_T$ is a lower or an upper integration bound would lead to a
duplication of the weights to compute. In order to simplify the
computation, we assume that the function $\mathcal{P}$ and its
derivative $\mathcal{P}'$ are slowly varying functions of $Q$ and $y$
over the typical grid interval of the grids in $Q$ and $\xi$. In
addition, the interpolating functions $\mathcal{I}_\tau(Q)$ and
$\mathcal{I}_\alpha(\xi)$ are strongly peaked at $Q_\tau$ and
$\xi_\alpha$, respectively. These considerations allow us to avoid
integrating explicitly $\mathcal{P}$ and $\mathcal{P}'$ over $Q$ and
$\xi$ and to replace the weights in Eq.~(\ref{eq:weights}) with:
\begin{equation}\label{eq:weightswithcuts}
  \displaystyle  W_{n\tau\alpha}(q_T) \rightarrow \left[\mathcal{P}\left(Q_\tau,\ln(\xi_\alpha),q_{T}\right) \pm
  \mathcal{P}'\left(Q_\tau,\ln(\xi_\alpha),q_{T}\right)\Delta q_T\right] W_{n\tau\alpha}(q_T)\,.
\end{equation}
At the end of the day, the only additional information required to
implement cuts on the final state is the value of the
phase-space-reduction function $\mathcal{P}$ and its derivative
$\mathcal{P}'$ on all points of the bidimensional grid in $Q$ and
$\xi$ for all $q_T$ bin bounds. Eq.~(\ref{eq:weightswithcuts}) will
then allow one to use the weights computed over the full phase space.
We will check the accuracy of this procedure by comparing it to the
explicit integration.

\subsection{Cross section differential in $x_F$}

In some cases, the Drell-Yan differential cross section may be
presented as differential in the invariant mass of the lepton pair $Q$
and, instead of the rapidity $y$, of the Feynman variable $x_F$
defined as:
\begin{equation}
  x_F = 
  \frac{Q}{\sqrt{s}}\left(e^{y} - e^{-y}\right) =
  \frac{2Q}{\sqrt{s}}\sinh y = x_1-x_2\,,
\end{equation}
so that:
\begin{equation}
\frac{dx_F}{dy} = \frac{2Q}{\sqrt{s}}\cosh y=x_1+x_2\,.
\end{equation}
Therefore:
\begin{equation}
  \frac{d\sigma}{dQ dx_F dq_T} =
  \frac{dy}{dx_F}\frac{d\sigma}{dQ dy dq_T}=
\frac{\sqrt{s}}{2Q\cosh y}\frac{d\sigma}{dQ dy dq_T}=\frac1{x_1+x_2}\frac{d\sigma}{dQ dy dq_T}
\end{equation}
with:
\begin{equation}
  y(x_F,Q) =
  \sinh^{-1}\left(\frac{x_F\sqrt{s}}{2Q}\right) =
  \ln\left[\frac{\sqrt{s}}{2Q}\left(x_F+\sqrt{x_F^2 + \frac{4Q^2}{s}}\right)\right]\,,
\end{equation}
so that:
\begin{equation}\label{eq:x12ofxFQ}
x_1 = \frac12\left(x_F+\sqrt{x_F^2 +
    \frac{4Q^2}{s}}\right)\quad\mbox{and}\quad x_2 = \frac{Q^2}{sx_1}\,.
\end{equation}
Therefore, we can compute the integral:
\begin{equation}
\widetilde{I}(q_T)=\int_{Q_{\rm min}}^{Q_{\rm max}}dQ \int_{x_{F,\rm
    min}}^{x_{F,\rm max}}dx_F\,I(Q,x_F,q_T)\,,
\end{equation}
where $I$ is the primitive in $q_T$ of the cross section differential
in $x_F$:
\begin{equation}
I(Q,x_F,q_T) = \int dq_T\left[\frac{d\sigma}{dQ dx_F dq_T}\right]\,,
\end{equation}
following the same steps of Sect.~\ref{sec:QyInt}. This leads to:
\begin{equation}
\begin{array}{rcl}
\displaystyle  \widetilde{I}(q_T) &\simeq& \displaystyle \sum_{n=1}^N
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_x}\overline{W}_{n\tau\alpha}(q_T) f_{\rm NP}\left(x_{1,\alpha\tau},\frac{z_n}{q_T};Q_\tau\right) f_{\rm NP}\left(x_{2,\alpha\tau},\frac{z_n}{q_T};Q_\tau\right)\,,
\end{array}
\end{equation}
with:
\begin{equation}\label{eq:xFtens}
\begin{array}{rcl}
\displaystyle  \overline{W}_{n\tau\alpha}(q_T) &\equiv& \displaystyle w_n^{(1)}\frac{8\pi}{9} \int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\mathcal{I}_\tau(Q)\, 
  \frac{1}{Q^3} \alpha^2(Q) H(Q) 
\\
\\
&\times& \displaystyle 
                         \int_{x_{F,\rm
    min}}^{x_{F,\rm max}}dx_F\,\mathcal{I}_\alpha(x_F)\,\frac{1}{x_1+x_2} \sum_q C_q(Q)\overline{F}_q\left(x_1,b_*\left(\frac{z_n}{q_T}\right);Q\right)
                         \overline{F}_{\bar{q}}\left(x_2,b_*\left(\frac{z_n}{q_T}\right);Q\right)\,,
\end{array}
\end{equation}
where $x_1$ and $x_2$ are functions of $x_F$ and $Q$ through
Eq.~(\ref{eq:x12ofxFQ}). In addition, we have defined a grid in $x_F$,
$\{x_{F,\alpha}\}$ with $\alpha = 0,\dots,N_x$, that allowed us to
define $x_{1(2),\alpha\tau}\equiv x_{1(2)}(x_{F,\alpha},Q_\tau)$.

\subsection{Flavour dependence}

It may be advantageous to introduce a flavour dependence of the
non-perturbative contributions to TMDs. This can be easily done by
observing that the tensor $W_{n\tau\alpha}$ defined in
Eq.~(\ref{eq:weights}) can be decomposed as\footnote{The same
  procedure applies to the tensor $\overline{W}_{n\tau\alpha}$ defined
in Eq.~(\ref{eq:xFtens}).}:
\begin{equation}
W_{n\tau\alpha}(q_T) = \sum_q W_{n\tau\alpha}^{(q)} (q_T)\,,
\end{equation}
with:
\begin{equation}\label{eq:weightsfl}
\begin{array}{rcl}
  \displaystyle  W_{n\tau\alpha}^{(q)}(q_T) & \equiv & \displaystyle w_n^{(1)}\frac{8\pi}{9} \int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\mathcal{I}_\tau(Q)\, 
                                            \frac{\alpha^2(Q)}{Q^3} H(Q) C_q(Q)
                                            \\
  \\
                                 &\times& \displaystyle 
                                          \int_{e^{y_{\rm
                                          min}}}^{e^{y_{\rm max}}}d\xi\,\mathcal{I}_\alpha(\xi)\,\frac{1}{\xi} \overline{F}_q\left(\frac{Q}{\sqrt{s}}\xi,b_*\left(\frac{z_n}{q_T}\right);Q\right)
                                          \overline{F}_{\bar{q}}\left(\frac{Q}{\sqrt{s}}\frac1{\xi},b_*\left(\frac{z_n}{q_T}\right);Q\right)\,.
\end{array}
\end{equation}
This allows for an independent parameterisation of the
non-perturbative contribution such that
Eq.~(\ref{eq:finalinterpolated}) can be written as:
\begin{equation}\label{eq:finalinterpolatedfl}
\widetilde{K}(q_T) \simeq \sum_q\sum_{n=1}^N
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_\xi} W_{n\tau\alpha}^{(q)}(q_T) f_{\rm NP}^{(q)}\left(\frac{Q_\tau}{\sqrt{s}}\xi_\alpha,\frac{z_n}{q_T};Q_\tau\right) f_{\rm NP}^{(q)}\left(\frac{Q_\tau}{\sqrt{s}}\frac1{\xi_\alpha},\frac{z_n}{q_T};Q_\tau\right)\,,
\end{equation}
where $f_{\rm NP}^{(q)}$ parametrises the non-perturbative component
of the TMD with flavour $q$.

\subsection{Gradient with respect to the free parameters}

A very appealing implication of the computation of cross section in
terms of precomputed table as in Eqs.~(\ref{eq:finalinterpolated})
and~(\ref{eq:finalinterpolatedfl}) is the fact that it exposes the
free parameters of the non-perturbative functions. To be more
specific, the non-perturbative function $f_{\rm NP}$, on top of being
a function of $x$, $b$, and $\zeta$, depends parameterically on a set
of $N_p$ parameters $\{\theta_k\}$, $k=1,\dots,N_p$, that are
typically determined by fits to data, in other words:
\begin{equation}
f_{\rm NP}\equiv f_{\rm NP}\left(x,b,\zeta;\{\theta_k\}\right)\,.
\end{equation}
Now, when performing a fit, it is very useful to be able to compute
the derivative of the figure of merit (usually the $\chi^2$) with
respect to the parameters to be determined. In turn, this immediately
implies being able to compute the derivative of the
observables. Referring to Eq.~(\ref{eq:finalinterpolated}), the
relevant quantity is:
\begin{equation}
\frac{d\widetilde{K}}{d\theta_k}=
\sum_{n=1}^N
  \sum_{\tau=0}^{N_Q}\sum_{\alpha=0}^{N_\xi} W_{n\tau\alpha}(q_T) \left[\frac{d f_{\rm NP}^{(1)}}{d\theta_k} f_{\rm NP}^{(2)}+f_{\rm NP}^{(1)}\frac{d f_{\rm NP}^{(2)}}{d\theta_k} \right]\,,
\end{equation}
where $f_{\rm NP}^{(1)}$ and $f_{\rm NP}^{(2)}$ refer to the
non-perturbative function $f_{\rm NP}$ computed in $x_1$ and $x_2$,
respectively. It is thus clear that the derivatives w.r.t. the free
parameters penetrates the observable. Since in most cases the
derivative of $f_{\rm NP}$ can be computed analytically, this allows
one to compute the gradient of the figure of merit analytically. This
potentially makes any fit much simpler.

\subsection{Narrow-width approximation}

A possible alternative to the numerical integration in $Q$ when the
integration region includes the $Z$-peak region is the so-called
narrow-width approximation (NWA). In the NWA one assumes that the
width of the $Z$ boson, $\Gamma_Z$, is much smaller than its mass,
$M_Z$. This way one can approximate the peaked behaviour of the
couplings $C_q(Q)$ around $Q=M_Z$ with a $\delta$-function,
\textit{i.e.}  $C_q(Q)\sim \delta(Q^2-M_Z^2)$. Therefore, the
integration over $Q$ can be done analytically. The exact structure of
the electroweak couplings is the following:
\begin{equation}\label{eq:fullcoup}
C_q(Q) = e_q^2 - 2 e_q V_q V_e \chi_1(Q) + (V_e^2 + A_e^2)(V_q^2 + A_q^2)\chi_2(Q)\,,
\end{equation}
with:
\begin{equation}
\begin{array}{l}
\displaystyle \chi_1(Q) = \frac{1}{4 \sin^2\theta_W \cos^2\theta_W } \frac{Q^2 ( Q^2 -  M_Z^2 )}{ (Q^2 - M_Z^2)^2 + M_Z^2 \Gamma_Z^2} \,,\\
\displaystyle \chi_2(Q) = \frac{1}{16 \sin^4\theta_W\cos^4\theta_W} \frac{Q^4}{ (Q^2 - M_Z^2)^2 + M_Z^2 \Gamma_Z^2} \,.
\end{array}
\end{equation}
In the limit $\Gamma_Z/M_Z\rightarrow 0$, the leading contribution to
the coupling in Eq.~(\ref{eq:fullcoup}) comes from the region
$Q\simeq M_Z$ and is that proportional to $\chi_2$:
\begin{equation}\label{eq:partlead}
C_q(Q) \simeq (V_e^2 + A_e^2)(V_q^2 + A_q^2)\chi_2(Q)\,,\quad Q\simeq M_Z\,.
\end{equation}
In addition, in this limit one can show that:
\begin{equation}\label{eq:breitwigner}
\frac{1}{ (Q^2 - M_Z^2)^2 + M_Z^2 \Gamma_Z^2}\rightarrow
\frac{\pi}{M_Z\Gamma_Z}\delta(Q^2-M_Z^2) = \frac{\pi}{2M_Z^2\Gamma_Z}\delta(Q-M_Z)\,.
\end{equation}
Therefore, considering that:
\begin{equation}
\Gamma_Z = \frac{\alpha M_Z}{\sin^2\theta_W \cos^2\theta_W}\,,
\end{equation}
the electroweak couplings in the NWA have the following form:
\begin{equation}\label{eq:partlead}
  C_q(Q) \simeq \frac{\pi M_Z (V_e^2 + A_e^2)(V_q^2 + A_q^2) }{32 \alpha
    \sin^2\theta_W\cos^2\theta_W} \delta(Q-M_Z)=\widetilde{C}_q(Q) \delta(Q-M_Z)\,.
\end{equation}
Therefore, using Eq.~(\ref{eq:partlead}) the integral of the cross
section over $Q$ under the condition that
$Q_{\rm min}<M_Z<Q_{\rm max}$ has the consequence of adjusting the
couplings and of setting $Q=M_Z$ in the computation. This yields:
\begin{equation}
\int_{Q_{\rm min}}^{Q_{\rm max}}dQ\,\frac{d\sigma}{dQ dy dq_T} =
 \frac{16\pi\alpha^2q_T}{9 M_Z^3} H(M_Z,M_Z) \sum_q \widetilde{C}_q(M_Z)
  I_{q\bar{q}}(x_1,x_2,q_T;M_Z,M_Z^2)\,,
\end{equation}
where we are also assuming that $\mu=\sqrt{\zeta}=M_Z$. As a final
step, one may want to let the $Z$ boson decay into leptons. At leading
order in the EW sector and assuming an equal decay rate for electrons,
muons, and tauons, this can be done by multiplying the cross section
above by three times the branching ratio for the $Z$ decaying into any
pair of leptons, $3\mbox{Br}(Z\rightarrow \ell^+\ell^-)$.

\appendix

\section{Ogata quadrature}\label{app:OgataQuadrature}

In this section we limit ourselves to write the formulas for the
computation of the unscaled coordinates $z_n^{(\nu)}$ and weights
$w_n^{(\nu)}$ required to compute the following integral:
\begin{equation}\label{eq:OgataQuadMast}
I_\nu(q_T)=\int_0^\infty db J_\nu(bq_T) f\left(b\right) =
\frac1{q_T}\int_0^\infty d\bar{b} J_\nu(\bar{b})
f\left(\frac{\bar{b}}{q_T}\right) \simeq
\frac{1}{q_T}\sum_{n=1}^\infty
w_n^{(\nu)}f\left(\frac{z_n^{(\nu)}}{q_T}\right)\quad \nu =0,1,\dots\,,
\end{equation}
using the Ogata-quadrature algorithm. More details can be found in
Ref.~\cite{Ogata:quadrature}. There relevant formulas are:
\begin{equation}
\begin{array}{l}
\displaystyle z_n^{(\nu)} = \frac{\pi}{h}  \psi\left(\frac{h\xi_{\nu
  n}}{\pi}\right)\,,\\
\\
\displaystyle w_n^{(\nu)}  = \pi\frac{Y_\nu(\xi_{\nu
  n})}{J_{\nu+1}(\xi_{\nu n})}  J_\nu(z_n^{(\nu)})  \psi'\left(\frac{h\xi_{\nu
  n}}{\pi}\right)\,.
\end{array}
\end{equation}
where:
\begin{itemize}
\item $h$ is a free parameter of the algorithm that has to be
  typically small (we choose $h = 10^{-3}$),
\item $\xi_{\nu n}$ are the zero's of $J_\nu$, \textit{i.e.}
  $J_\nu(\xi_{\nu n}) = 0$ $\forall\, n$,
\item $J_\nu$ and $Y_\nu$ are the Bessel functions of first and second
  kind, respectively, of degree $\nu$,
\item $\psi$ is the following function:
\begin{equation}
\psi(t) = t\tanh\left(\frac{\pi}{2}\sinh t\right)
\end{equation}
and its derivative:
\begin{equation}
\psi'(t) =  \frac{\pi t \cosh t + \sinh( \pi \sinh t ) }{1 +
  \cosh( \pi \sinh t  ) }\,.
\end{equation}
\end{itemize}

\section{Lagrange interpolation}\label{app:LagrangeInterpolation}

Just for the record, it is useful to derive a general expression for
the Lagrange interpolating functions $\mathcal{I}$ introduced in
Eq.~(\ref{eq:interpolation}) and used to interpolate the
non-perturbative functions $f_{\rm NP}$. More, importantly, we need to
understand how these functions behave upon integration.

Suppose one wants to interpolate the test function $g$ in the point
$x$ using a set of Lagrange polynomials of degree $k$ of. This
requires a subset of $k+1$ consecutive points on an interpolation
grid, say $\{x_{\alpha},\dots,x_{\alpha+k}\}$. The relative position
between the point $x$ and the subset of points used for the
interpolation is arbitrary. It is convenient to choose the subset of
points such that $x_\alpha < x \leq x_{\alpha+k}$.\footnote{In fact,
  it is not even necessary to impose the constraint
  $x_\alpha < x \leq x_{\alpha+k}$.  In case this relation is not
  fulfilled one usually refers to \textit{extrapolation} rather than
  \textit{interpolation}. If not necessary, this option is typically
  not convenient because it may lead to a substantial deterioration in
  the accuracy with which $g(x)$ is determined.}  However, the
ambiguity remains because there are $k$ possible choices according to
whether $x_\alpha < x \leq x_{\alpha+1}$, or
$x_{\alpha+1} < x \leq x_{\alpha+2}$, and so on.

In order to determine the exact form of the interpolation functions
$\mathcal{I}$, let us see how to derive
eq.~(\ref{eq:interpolation}). Using the standard Lagrange
interpolation procedure, we can approximate the function $g$ in $x$
as:
\begin{equation}\label{particularCase}
g(x) = \sum_{i=0}^k\ell_i^{(k)}(x)g(x_{\alpha+i})\,,
\end{equation}
where $\ell_i^{(k)}$ is the $i$-th Lagrange polynomial of degree $k$
which can be written as:
\begin{equation} \ell_i^{(k)}(x) = \prod^{k}_{m=0,m\ne
i}\frac{x-x_{\alpha+m}}{x_{\alpha+i}-x_{\alpha+m}}\,.
\end{equation}
We now assume that:
\begin{equation}\label{eq:assumption1}
x_{\alpha} < x \leq x_{\alpha+1}\,,
\end{equation}
Eq.~(\ref{particularCase}) becomes:
\begin{equation}\label{particularCaseTheta}
  g(x) =
  \theta(x-x_{\alpha})\theta(x_{\alpha+1}-x)\sum_{i=0}^k
  g(x_{\alpha+i})\prod^{k}_{m=0,m\ne
    i}\frac{x-x_{\alpha+m}}{x_{\alpha+i}-x_{\alpha+m}}\,.
\end{equation}

In order to make Eq.~(\ref{particularCaseTheta}) valid for all values
of $\alpha$, one just has to sum over all $N_x$ intervals of the
\textit{global} interpolation grid $\{x_0,\dots,x_{N_x}\}$, that is:
\begin{equation}\label{generalCase}
  g(x) =
  \sum_{\alpha=0}^{N_x-1}\theta(x-x_{\alpha})\theta(x_{\alpha+1}-x)\sum_{i=0}^k
  g(x_{\alpha+i})\prod^{k}_{m=0,m\ne
    i}\frac{x-x_{\alpha+m}}{x_{\alpha+i}-x_{\alpha+m}}\,,
\end{equation}

Defining $\beta=\alpha+i$, we can rearrange the equation above as:
\begin{equation}\label{generalCase2}
  g(x) =
  \sum_{\beta=0}^{N_x+k-1}\mathcal{I}_\beta^{(k)}(x) g(x_{\beta})\,,
\end{equation}
that leads us to the definition of the interpolating functions:
\begin{equation}\label{eq:intfunc}
  \mathcal{I}_\beta^{(k)}(x) = \sum_{i=0,i\leq\beta}^k
  \theta(x-x_{\beta-i})\theta(x_{\beta-i+1}-x) \prod^{k}_{m=0,m\ne
    i}\frac{x-x_{\beta-i+m}}{x_{\beta}-x_{\beta-i+m}}\,,
\end{equation}
where the condition $i\leq\beta$ comes from the condition
$\alpha\geq 0$. It is important to observe that the sum in
Eq.~(\ref{generalCase2}) extends up to the $(N_x+k-1)$-th
node. Therefore, the original grid needs to be extended by $k-1$
nodes. However, the range of validity of the interpolation remains
that defined by the original grid, \textit{i.e.}
$x_0 \leq x \leq x_{N_x}$. Finally, it is crucial to realise that the
interpolation function $\mathcal{I}_\beta^{(k)}(x)$ is different from
zero only over a limited interval, specifically:
\begin{equation}\label{eq:limits}
\mathcal{I}_\beta^{(k)}(x) \neq 0\quad \Leftrightarrow\quad
x_{\beta-k}<x < x_{\beta+1}\,.
\end{equation}

In the rest of this document we will stick to the assumption in
Eq.~(\ref{eq:assumption1}). However, before going further, it is
interesting to generalise Eq.~(\ref{eq:assumption1}) to:
\begin{equation}\label{IntAssumptionGen}
  x_{\alpha+t} < x \leq
  x_{\alpha+t+1}\quad\mbox{with}\quad t = 0,\dots,k-1\,,
\end{equation}
such that the interpolation formula becomes:
\begin{equation}\label{MoreGeneralCase}
  g(x) =
  \sum_{\alpha=-t}^{N_x-t-1}\theta(x-x_{\alpha+t})\theta(x_{\alpha+t+1}-x)\sum_{i=0}^k
  g(x_{\alpha+i})\prod^{k}_{m=0,m\ne
    i}\frac{x-x_{\alpha+m}}{x_{\alpha+i}-x_{\alpha+m}}\,,
\end{equation}
that can be rearranged as:
\begin{equation}\label{generalCase3} g(x) =
\sum_{\beta=-t}^{N_x+k-t-1}\mathcal{I}_{\beta,t}^{(k)}(x) g(x_{\beta})\,,
\end{equation}
with:
\begin{equation}\label{eq:generalisedintfuncs}
\mathcal{I}_{\beta,t}^{(k)}(x) = \sum_{i=0,i\leq\beta}^k
\theta(x-x_{\beta-i+t})\theta(x_{\beta-i+t+1}-x) \prod^{k}_{m=0,m\ne
i}\frac{x-x_{\beta-i+m}}{x_{\beta}-x_{\beta-i+m}}\,,
\end{equation}
being the ``generalised'' interpolation functions.  The generalised
interpolation functions can be used to overcome the ``drawback'' of
requiring $k-1$ additional nodes on the interpolation grid. In
practice, given the grid $\{x_0,\dots,x_{N_x}\}$, one can tune $t$
according to the position of $x$ on the grid. More specifically, one
can choose $t$ in such a way that $\beta+t$ in
Eq.~(\ref{eq:generalisedintfuncs}) never exceeds $N_x$.

Now suppose we want to compute the following intergral:
\begin{equation}
I_1 = \int_{x_0}^{x_{N_x}}dx\,g(x)f(x)\,,
\end{equation}
where $f$ is some other function that we don't want to
interpolate. Using Eqs.~(\ref{generalCase2}) and~(\ref{eq:limits}) we
finally have that:
\begin{equation}
  I_1 = \sum_{\beta=0}^{N_x+k-1} W_\beta g(x_{\beta})\,,
\end{equation}
with:
\begin{equation}\label{eq:monodim}
W_\beta = \int_{x_{{\rm max}(0,\beta-k)}}^{x_{{\rm min}(N_x,\beta+1)}}dx \,\mathcal{I}_\beta^{(k)}(x)f(x)\,.
\end{equation}
The equation above can be easily generalised to a bidimensional
integral as:
\begin{equation}
I_2 = \int_{x_0}^{x_{N_x}}dx \int_{y_0}^{y_{N_y}}dy\,g(x,y)f(x,y) = \sum_{\alpha=0}^{N_x+k-1} \sum_{\beta=0}^{N_y+l-1} W_{\alpha\beta} g(x_{\alpha},y_{\beta})\,,
\end{equation}
with:
\begin{equation}\label{eq:bidim}
W_{\alpha\beta} = \int_{x_{{\rm max}(0,\alpha-k)}}^{x_{{\rm
      min}(N_x,\alpha+1)}}dx \int_{y_{{\rm max}(0,\beta-k)}}^{y_{{\rm
      min}(N_y,\beta+1)}}dy \,\mathcal{I}_\alpha^{(k)}(x)\,\mathcal{I}_\beta^{(l)}(y)\,f(x,y)\,.
\end{equation}
This formalism nicely applies to the integral in $Q$ and $\xi=e^{y}$
discussed above in Eq.~(\ref{eq:weights}). In view of a numerical
implementation, it is worth noticing that the functions $\mathcal{I}$
are piecewise. In particular, while these functions are continuos in
correspondence of the nodes of the grid, their first derivative is
not. As a consequence, the result of the numerical integrals in
Eqs.~(\ref{eq:monodim}) and~(\ref{eq:bidim}) may be inaccurate. To
overcome this problem, it is sufficient to split the integrals in
sub-integrals over the intervals delimited by two consecutive
nodes. Using Eq.~(\ref{eq:limits}), it is easy to see that, for an
interpolation of degree $k$, one needs to do $k+1$ integrals over the
intervals included between the $(\beta-k)$-th and the $(\beta+1)$-th
node.

\section{Cuts on the final-state leptons}

In this section we derive explicitly the phase-space reduction factor
$\mathcal{P}$ introduced in Sect.~\ref{sec:kincuts}. This factor is
defined as:
\begin{equation}\label{eq:PSredDef}
\mathcal{P}(Q,y,q_T) = \mathcal{P}(q) = \frac{\displaystyle \int_{\mbox{\footnotesize fid.
    reg.}}d^4p_1 d^4p_2 \,\delta(p_1^2) \delta(p_2^2)\theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) g_{\mu\nu}L^{\mu\nu}(p_1,p_2)}{\displaystyle \int d^4p_1 d^4p_2\, \delta(p_1^2) \delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) g_{\mu\nu}L^{\mu\nu}(p_1,p_2)}\,,
\end{equation}
where $p_1$ and $p_2$ are the four-momenta of the outgoing leptons
and $L^{\mu\nu}$ is the leptonic tensor that, assuming massless
leptons, reads:
\begin{equation}
L^{\mu\nu}(p_1,p_2) = 4(p_1^{\mu}p_2^{\nu}+p_2^{\mu}p_1^{\nu}-g^{\mu\nu}p_1p_2)\,,
\end{equation}
so that:
\begin{equation}
g_{\mu\nu}L^{\mu\nu}(p_1,p_2) = -8(p_1p_2) = -4(p_1+p_2)^2\,.
\end{equation}
In the last step we have used the on-shell-ness of the leptons
($p_1^2=p_2^2=0$). The integral in the denominator of
Eq.~(\ref{eq:PSredDef}) is restricted to some \textit{fiducial
  region}. Finally, we find:
\begin{equation}\label{eq:PSredDef2}
\mathcal{P}(q) = \frac{\displaystyle \int_{\mbox{\footnotesize fid.
    reg.}}d^4p_1 d^4p_2 \,\delta(p_1^2) \delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) (p_1+p_2)^2}{\displaystyle \int d^4p_1 d^4p_2\, \delta(p_1^2) \delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) (p_1+p_2)^2}\,.
\end{equation}
The effect of integrating over the fiducial region can be implemented
by defining a generalised $\theta$-function, $\Phi(p_1,p_2)$, that is
equal to one inside the fiducial region and zero outside. This allows
one to integrate also the numerator of Eq.~(\ref{eq:PSredDef2}) over
the full phase-space of the two outgoing leptons:
\begin{equation}\label{eq:PSredDef3}
\mathcal{P}(q) = \frac{\displaystyle \int d^4p_1 d^4p_2 \,\delta(p_1^2) \delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) \Phi(p_1,p_2) (p_1+p_2)^2}{\displaystyle \int d^4p_1 d^4p_2\, \delta(p_1^2) \delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q) (p_1+p_2)^2}\,.
\end{equation}
Now we can integrate over one of the outgoing momenta, say $p_2$,
exploiting the momentum-conservation $\delta$-function both in the
numerator and in the denominator. Specifically, the numerator of
Eq.~(\ref{eq:PSredDef3}) gives:
\begin{equation}
\begin{array}{c}
\displaystyle \int d^4p_1 d^4p_2\, \delta(p_1^2)
\delta(p_2^2) \theta(p_{1,0}) \theta(p_{2,0})\delta^{(4)}(p_1+p_2-q)
  \Phi(p_1,p_2) (p_1+p_2)^2 = \\
\\
\displaystyle Q^2 \int d^4p_1 \delta(p_1^2)
\delta((q-p_1)^2) \theta(p_{1,0})
  \theta(q_0-p_{1,0})\Phi(p_1,q-p_1)\,,
\end{array}
\end{equation}
and likewise in the denominator setting $\Phi(p_1,p_2)=1$. Finally,
renaming $p_1=p$, the phase-space reduction factor reads:
\begin{equation}\label{eq:PSredDef3}
  \mathcal{P}(q) = \frac{\displaystyle \int d^4p \delta(p^2) \delta((q-p)^2) \theta(p_{0})
    \theta(q_0-p_{0})  \Phi(p,q-p)}{\displaystyle \int d^4p \delta(p^2) \theta(p_{0})
    \theta(q_0-p_{0})  \delta((q-p)^2)}\,.
\end{equation}
The $\delta$-functions can now be used to constrain two of the four
components of the momentum $p$. The first, $\delta(p_2^2)$, is usually
used to set the first component of $p$, the energy, to the on-shell
value. Since the leptons are assumed to be massless, this
produces:
\begin{equation}
\int d^4p\delta(p^2)\theta(p_0) = \int d^4p\delta(E^2-|\mathbf{p}|^2)\theta(E)=\int\frac{dEd^3\mathbf{p}}{2|\mathbf{p}|}\delta(E-|\mathbf{p}|)=\int\frac{d^3\mathbf{p}}{2|\mathbf{p}|}\,.
\end{equation}
Of course, the four-momentum $p$ appearing in the rest of the
integrand has to be set on shell ($E=|\mathbf{p}|$). Now we express
the three-dimensional measure $d^3\mathbf{p}$ in spherical coordinates
as:
\begin{equation}
d^3\mathbf{p} = |\mathbf{p}|^2d|\mathbf{p}|d(\cos\theta) d\phi\,.
\end{equation}
Then we make a change of variable from $(|\mathbf{p}|,\cos\theta)$ to
$(|\mathbf{p}_T|,\eta)$: the second set of variables are exactly those
on which kinematic cuts are imposed. We do so by knowing that:
\begin{equation}
\left\{
\begin{array}{l}
|\mathbf{p}| = |\mathbf{p}_T|\cosh\eta\,,\\
\cos\theta =\tanh\eta\,.
\end{array}
\right.
\end{equation}
This leads to:
\begin{equation}
\int\frac{d^3\mathbf{p}}{2 |\mathbf{p}|} = \int|\mathbf{p}|d|\mathbf{p}|d(\cos\theta) d\phi=\int|\mathbf{p}_T|d|\mathbf{p}_T|d\eta d\phi=\int d^2\mathbf{p}_T d\eta\,.
\end{equation}

Now we consider the second $\delta$-function:
\begin{equation}\label{eq:integralyeah!}
\int d^2\mathbf{p}_T d\eta\,\delta((q-p)^2)\theta(q_0-p_0)=\int_0^\infty|\mathbf{p}_T|d|\mathbf{p}_T|\int_{-\infty}^\infty d\eta
\int_0^{2\pi} d\phi\,\delta(Q^2-2p\cdot q) \theta(q_0-p_0)\,,
\end{equation}
being $q^2=Q^2$ and $p^2=0$. The goal is that of using this last
$\delta$-function to get rid of the integral over $\phi$. To do so, it
is convenient to express the four-vector $q$ in terms of $Q$, $y$, and
$\mathbf{q}_T$:
\begin{equation}
q=\left(M\cosh y,\mathbf{q}_T,M\sinh y\right)\,.
\end{equation}
with $M=\sqrt{Q^2+|\mathbf{q}_T|^2}$. While:
\begin{equation}
p=\left(|\mathbf{p}_T|\cosh\eta,\mathbf{p}_T,|\mathbf{p}_T|\sinh\eta\right)\,,
\end{equation}
so that:
\begin{equation}
p\cdot q=|\mathbf{p}_T|M\left(\cosh\eta \cosh y-\sinh\eta\sinh
  y\right)-\mathbf{p}_T\cdot
\mathbf{q}_T=|\mathbf{p}_T|M\cosh\left(\eta - y\right)-\mathbf{p}_T\cdot \mathbf{q}_T\,.
\end{equation}
We can now assume that the two-dimensional vector $\mathbf{q}_T$ is
aligned with the $x$ axis so that 
$\mathbf{p}_T\cdot \mathbf{q}_T =
|\mathbf{p}_T||\mathbf{q}_T|\cos\phi$(\footnote{In
  the general case in which $\mathbf{q}_T$ forms an angle $\beta$ with
  the $x$ axis, the scalar product would result in
  $|\mathbf{p}_T||\mathbf{q}_T|\cos(\phi-\beta)$. However, the angle
  $\beta$ could always be reabsorbed in a redefinition of the
  integration angle $\phi$ in
  Eq.~(\ref{eq:integralyeah!}).}). Therefore, the integral of the
$\delta$-function over the angle $\phi$ becomes:
\begin{equation}
\int_0^{2\pi} d\phi\,\delta(Q^2-2p\cdot q)=\int_0^{2\pi} d\phi\,\delta\left(Q^2-2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)+2|\mathbf{p}_T||\mathbf{q}_T|\cos\phi\right)\,,
\end{equation}
The argument of the delta function:
\begin{equation}
f(\phi) = Q^2-2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)+2|\mathbf{p}_T||\mathbf{q}_T|\cos\phi\,,
\end{equation}
whose derivative is:
\begin{equation}
\frac{df(\phi)}{d\phi} = -2|\mathbf{p}_T||\mathbf{q}_T|\sin\phi\,,
\end{equation}
has a zero in $\phi_0$ such that:
\begin{equation}\label{eq:cosphi0}
\cos\phi_0=\frac{2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)-Q^2}{2|\mathbf{p}_T||\mathbf{q}_T|}\,,
\end{equation}
so that:
\begin{equation}\label{eq:derivphi0}
\left|\frac{df(\phi)}{d\phi}\right|_{\phi=\phi_0} = 2|\mathbf{p}_T||\mathbf{q}_T|\sin\phi_0=\sqrt{4|\mathbf{p}_T|^2|\mathbf{q}_T|^2-\left(2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)-Q^2\right)^2}\,,
\end{equation}
that gives:
\begin{equation}
\int_0^{2\pi} d\phi\,\delta(Q^2-2p\cdot q)=\left|\frac{df(\phi)}{d\phi}\right|^{-1}_{\phi=\phi_0}\int_0^{2\pi} d\phi\,\delta(\phi-\phi_0)=\frac1{\sqrt{4|\mathbf{p}_T|^2|\mathbf{q}_T|^2-\left(2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)-Q^2\right)^2}}\,.
\end{equation}
Of course, the equality in Eq.~(\ref{eq:cosphi0}) is possible only if:
\begin{equation}\label{eq:cosphi0}
|2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)-Q^2|\leq 2|\mathbf{p}_T||\mathbf{q}_T|\,.
\end{equation}
that is such to make the argument of the square root in
Eq.~(\ref{eq:derivphi0}) non-negative. This sets additional
constraints on the integration domain(\footnote{Notice that
  $M\cosh(\eta-y)\geq |\mathbf{q}_T|$.}):
\begin{equation}
p_T^{-} \leq |\mathbf{p}_T| \leq p_T^{+}\quad\mbox{with}\quad
p_T^{\pm}=\frac{Q^2}{M\cosh(\eta-y)\mp |\mathbf{q}_T|}\,.
\end{equation}
In addition, one has to take into account the $\theta$-function in
Eq.~(\ref{eq:integralyeah!}) that guarantees the positiveness of the
energy:
\begin{equation}
\theta(q_0-p_0)=\theta(M\cosh y-|\mathbf{p}_T|\cosh\eta)\quad\Rightarrow\quad |\mathbf{p}_T|\leq
p_T^{(E)} = \frac{M\cosh y}{\cosh\eta}\,.
\end{equation}
Finally, we have:
\begin{equation}
\int d^4p \delta(p^2) \delta((q-p)^2)=\int_{-\infty}^\infty d\eta
\int_{p_T^{-}}^{{\rm min}(p_T^{+},p_T^{(E)})}
\frac{d|\mathbf{p}_T||\mathbf{p}_T|}{\sqrt{4|\mathbf{p}_T|^2|\mathbf{q}_T|^2-\left(2 |\mathbf{p}_T|M\cosh\left(\eta - y\right)-Q^2\right)^2}}\,.
\end{equation}


\newpage

\begin{thebibliography}{alp}

%\cite{Scimemi:2017etj}
\bibitem{Scimemi:2017etj}
  I.~Scimemi and A.~Vladimirov,
  %``Analysis of vector boson production within TMD factorization,''
  arXiv:1706.01473 [hep-ph].
  %%CITATION = ARXIV:1706.01473;%%
  %2 citations counted in INSPIRE as of 24 Oct 2017

%\cite{Collins:2011zzd}
\bibitem{Collins:2011zzd}
  J.~Collins,
  %``Foundations of perturbative QCD,''
  Camb.\ Monogr.\ Part.\ Phys.\ Nucl.\ Phys.\ Cosmol.\  {\bf 32} (2011) 1.
  %%CITATION = CMPCE,32,1;%%
  %327 citations counted in INSPIRE as of 21 Oct 2018

\bibitem{Ogata:quadrature}
  H.~Ogata,
  ``A Numerical Integration Formula Based on the Bessel Functions,''
  \texttt{http://www.kurims.kyoto-u.ac.jp/$\sim$okamoto/paper/Publ\_RIMS\_DE/41-4-40.pdf}

\end{thebibliography}

\end{document}
